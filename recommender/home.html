{% load static %}
<!doctype html>
<html>
<head>
  <title>NextTrack – Recommendations</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.10"></script>
</head>
<body class="font-sans p-6">
  <h1 class="text-2xl font-bold mb-4">Your Recommendations</h1>

  <button hx-get="/api/recommend/" hx-target="#recs" hx-swap="innerHTML"
          class="px-4 py-2 bg-green-600 text-white rounded-lg">Refresh</button>

  <ul id="recs" class="mt-6 space-y-2">
    <!-- htmx がここへ挿入 -->
  </ul>

  <template id="track-tmpl">
    <li class="p-2 rounded shadow flex justify-between items-center">
      <span class="truncate font-medium"></span>
      <button class="text-sm text-blue-600">Similar</button>
    </li>
  </template>

  <script>
    document.body.addEventListener("htmx:afterSwap", e => {
      if (e.target.id !== "recs") return
      const tmpl = document.getElementById('track-tmpl')
      e.detail.xhr.responseJSON.forEach(t => {
        const el = tmpl.content.cloneNode(true)
        el.querySelector("span").textContent = `${t.title} — ${t.artist.name}`
        el.querySelector("button").onclick = () => {
          fetch(`/api/similar/${t.spotify_id}/`)
            .then(r => r.json())
            .then(arr => alert(arr.map(x => x.title).join("\n")))
        }
        e.target.appendChild(el)
      })
    })
  </script>
</body>
</html>
