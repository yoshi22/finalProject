{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="deepcut-unified-container">
    {# Add breadcrumb navigation #}
    {% include "_breadcrumb.html" with breadcrumb_items=breadcrumb_items %}
    
    <h2>Deep-cut Discoveries for {{ base_track }}</h2>
    
    <!-- Exploration Level Control (Always Visible) -->
    <div class="exploration-control">
        <form method="get" id="exploration-form">
            <input type="hidden" name="artist" value="{{ request.GET.artist }}">
            <input type="hidden" name="track" value="{{ request.GET.track }}">
            
            <div class="exploration-header">
                <label for="exploration-slider">
                    Exploration Level: 
                    <span id="exploration-value">{{ exploration_level|floatformat:1 }}</span>
                </label>
                
                <!-- Advanced Toggle Button -->
                <button type="button" id="advanced-toggle" class="btn btn-sm btn-secondary">
                    <span class="toggle-icon">‚ñ∂</span>
                    <span class="toggle-text">Show Advanced Options</span>
                </button>
            </div>
            
            <div class="slider-container">
                <span class="slider-label">Safe</span>
                <input type="range" 
                       id="exploration-slider" 
                       name="exploration_level"
                       min="0" 
                       max="1" 
                       step="0.1" 
                       value="{{ exploration_level }}">
                <span class="slider-label">Extreme</span>
                <button type="submit" class="btn btn-primary btn-sm">Apply</button>
            </div>
            
            <p class="slider-description">
                {{ exploration_description|default:"Adjust the slider to control how adventurous your music discovery will be" }}
            </p>
            
            <!-- Advanced Options (Initially Hidden) -->
            <div id="advanced-options" class="advanced-options" style="display: none;">
                <h4>Manual Filters</h4>
                <div class="filter-grid">
                    <div class="filter-item">
                        <label>Max Playcount</label>
                        <input type="number" name="max_play" 
                               value="{{ max_play }}" placeholder="100000">
                    </div>
                    <div class="filter-item">
                        <label>Ratio</label>
                        <input type="number" step="0.05" min="0" max="1" 
                               name="ratio" value="{{ ratio }}" placeholder="0.5">
                    </div>
                    <div class="filter-item">
                        <label>Tag</label>
                        <input name="tag" value="{{ tag }}" placeholder="indie">
                    </div>
                    <div class="filter-item">
                        <label>Year</label>
                        <input name="year" value="{{ year }}" placeholder="2020">
                    </div>
                </div>
                
                <div class="advanced-controls">
                    <label>
                        <input type="checkbox" name="show_scores" 
                               {% if show_scores %}checked{% endif %}>
                        Show Detailed Scores
                    </label>
                    <label>
                        <input type="checkbox" name="show_explanations" 
                               {% if show_explanations %}checked{% endif %}>
                        Show Recommendations Explanations
                    </label>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Results Grid -->
    <div class="deepcut-results grid">
        {% if use_enhanced %}
            <!-- Enhanced Mode Results -->
            {% for item in deepcuts %}
            <div class="deepcut-card" data-track-id="{{ item.candidate.track.id }}">
                <div class="track-info">
                    <h3>{{ item.candidate.track.title }}</h3>
                    <p class="artist">{{ item.candidate.track.artist.name }}</p>
                    
                    <!-- Score Visualization (Conditional) -->
                    {% if show_scores %}
                    <div class="score-visualization">
                        <div class="score-bar">
                            <div class="score-segment similarity" 
                                 style="width: {% widthratio item.candidate.similarity_score 1 100 %}%"
                                 title="Similarity: {{ item.candidate.similarity_score|floatformat:2 }}">
                            </div>
                            <div class="score-segment novelty" 
                                 style="width: {% widthratio item.candidate.novelty_score 1 100 %}%"
                                 title="Novelty: {{ item.candidate.novelty_score|floatformat:2 }}">
                            </div>
                            <div class="score-segment rarity" 
                                 style="width: {% widthratio item.candidate.popularity_score 1 100 %}%"
                                 title="Rarity: {{ item.candidate.popularity_score|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="score-legend">
                            <span class="legend-item similarity">Similar</span>
                            <span class="legend-item novelty">Novel</span>
                            <span class="legend-item rarity">Rare</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Explanation (Conditional) -->
                    {% if show_explanations and item.explanation %}
                    <div class="explanation">
                        <p>{{ item.explanation }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Metadata -->
                    <div class="track-metadata">
                        <span class="playcount">
                            üéµ {{ item.candidate.track.playcount|default:"Unknown" }} plays
                        </span>
                        {% if show_scores %}
                        <span class="overall-score">
                            Score: {{ item.candidate.overall_score|floatformat:2 }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Preview & Actions -->
                <div class="track-actions">
                    {% if item.apple_preview or item.youtube_url %}
                    <details class="preview-section">
                        <summary>üîä Preview</summary>
                        {% if item.apple_preview %}
                        <audio controls preload="none">
                            <source src="{{ item.apple_preview }}" type="audio/mpeg">
                        </audio>
                        {% endif %}
                        {% if item.youtube_url %}
                        <a href="{{ item.youtube_url }}" target="_blank" class="youtube-link">
                            Watch on YouTube
                        </a>
                        {% endif %}
                    </details>
                    {% endif %}
                    
                    <!-- Feedback Buttons (Conditional) -->
                    {% if use_enhanced %}
                    <div class="feedback-buttons">
                        <button class="btn-feedback btn-like" 
                                data-track-id="{{ item.candidate.track.id }}"
                                data-feedback="like"
                                title="Like">
                            üëç
                        </button>
                        <button class="btn-feedback btn-dislike" 
                                data-track-id="{{ item.candidate.track.id }}"
                                data-feedback="dislike"
                                title="Dislike">
                            üëé
                        </button>
                        <button class="btn-feedback btn-save" 
                                data-track-id="{{ item.candidate.track.id }}"
                                data-feedback="save"
                                data-artist="{{ item.candidate.track.artist.name|escape }}"
                                data-track="{{ item.candidate.track.title|escape }}"
                                title="Save">
                            üíæ
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Standard Mode Results -->
            {% for t in tracks %}
            <div class="card">
                <h3>{{ t.name }}</h3>
                <p class="meta">{{ t.artist.name }} ‚Ä¢ {{ t.playcount|default:"?" }} plays</p>
                
                {% if t.apple_preview or t.youtube_url %}
                <details>
                    <summary>Preview</summary>
                    {% include "_preview_player.html" with track=t %}
                </details>
                {% endif %}
                
                <!-- Simple Actions -->
                <div class="track-actions-simple">
                    <button class="btn btn-sm btn-save-standard" 
                            data-artist="{{ t.artist.name|escape }}"
                            data-track="{{ t.name|escape }}"
                            onclick="if(window.NextTrack && window.NextTrack.showAddToPlaylist) window.NextTrack.showAddToPlaylist(this);"
                            title="Save to Playlist">
                        üíæ Save
                    </button>
                    <a href="{% url 'similar' %}?artist={{ t.artist.name|urlencode:"" }}&track={{ t.name|urlencode:"" }}" 
                       class="btn btn-sm">Similar</a>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        
        {% if not deepcuts and not tracks %}
        <p class="no-results">No deep-cuts found. Try adjusting the exploration level or filters.</p>
        {% endif %}
    </div>
</div>

<style>
.deepcut-unified-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.exploration-control {
    background: var(--card-bg, #f9f9f9);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.exploration-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

#advanced-toggle {
    display: flex;
    align-items: center;
    gap: 5px;
    background: transparent;
    border: 1px solid var(--border-color, #dee2e6);
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}

#advanced-toggle:hover {
    background: var(--bg-secondary, #f8f9fa);
}

#advanced-toggle .toggle-icon {
    transition: transform 0.3s;
    display: inline-block;
}

#advanced-toggle.active .toggle-icon {
    transform: rotate(90deg);
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 15px 0;
}

#exploration-slider {
    flex: 1;
    -webkit-appearance: none;
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(to right, 
        #4CAF50 0%, 
        #FFC107 50%, 
        #F44336 100%);
    outline: none;
}

#exploration-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-color, #007bff);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.slider-label {
    font-size: 0.875rem;
    color: var(--text-secondary, #666);
    white-space: nowrap;
}

.slider-description {
    font-style: italic;
    color: var(--text-secondary, #666);
    margin-top: 10px;
}

/* Advanced Options Styles */
.advanced-options {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color, #dee2e6);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.filter-item label {
    display: block;
    font-size: 0.875rem;
    margin-bottom: 5px;
    color: var(--text-secondary, #666);
}

.filter-item input {
    width: 100%;
    padding: 5px;
    border: 1px solid var(--border-color, #dee2e6);
    border-radius: 4px;
}

.advanced-controls {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}

.advanced-controls label {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

/* Result Cards */
.deepcut-card {
    background: var(--card-bg, white);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.deepcut-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.track-info h3 {
    margin: 0 0 5px 0;
    color: var(--text-primary, #333);
}

.track-info .artist {
    color: var(--text-secondary, #666);
    margin: 0 0 15px 0;
}

/* Score Visualization */
.score-visualization {
    margin: 15px 0;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.score-bar {
    display: flex;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    background: var(--bg-secondary, #e9ecef);
}

.score-segment {
    transition: width 0.3s ease;
}

.score-segment.similarity {
    background: #4CAF50;
}

.score-segment.novelty {
    background: #2196F3;
}

.score-segment.rarity {
    background: #FF9800;
}

.score-legend {
    display: flex;
    gap: 20px;
    margin-top: 8px;
    font-size: 0.75rem;
}

.legend-item {
    display: flex;
    align-items: center;
}

.legend-item::before {
    content: '';
    width: 12px;
    height: 12px;
    border-radius: 2px;
    margin-right: 5px;
}

.legend-item.similarity::before {
    background: #4CAF50;
}

.legend-item.novelty::before {
    background: #2196F3;
}

.legend-item.rarity::before {
    background: #FF9800;
}

/* Explanation */
.explanation {
    background: var(--bg-secondary, #f8f9fa);
    padding: 12px;
    border-radius: 6px;
    margin: 15px 0;
    animation: fadeIn 0.5s ease;
}

.explanation p {
    margin: 0;
    font-style: italic;
    color: var(--text-secondary, #666);
    font-size: 0.9rem;
}

/* Track Metadata */
.track-metadata {
    display: flex;
    gap: 20px;
    font-size: 0.875rem;
    color: var(--text-secondary, #666);
    margin: 10px 0;
}

/* Track Actions */
.track-actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color, #dee2e6);
}

.preview-section {
    margin-bottom: 10px;
}

.preview-section summary {
    cursor: pointer;
    user-select: none;
    padding: 5px;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 4px;
    display: inline-block;
}

.preview-section audio {
    width: 100%;
    margin-top: 10px;
}

.youtube-link {
    display: inline-block;
    margin-top: 10px;
    color: var(--primary-color, #007bff);
    text-decoration: none;
}

/* Feedback Buttons */
.feedback-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.btn-feedback {
    background: transparent;
    border: 1px solid var(--border-color, #dee2e6);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1.2rem;
}

.btn-feedback:hover {
    transform: scale(1.1);
    background: var(--bg-secondary, #f8f9fa);
}

.btn-feedback.active {
    background: var(--primary-color, #007bff);
    border-color: var(--primary-color, #007bff);
}

/* Simple Track Actions */
.track-actions-simple {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.btn-save-standard {
    background: var(--success-color, #28a745);
    color: white;
    border: none;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background 0.3s;
}

.btn-save-standard:hover {
    background: var(--success-hover, #218838);
}

.no-results {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary, #666);
    grid-column: 1 / -1;
}

/* Responsive Design */
@media (max-width: 768px) {
    .deepcut-results {
        grid-template-columns: 1fr;
    }
    
    .exploration-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .slider-container {
        flex-wrap: wrap;
    }
    
    #exploration-slider {
        width: 100%;
    }
    
    .filter-grid {
        grid-template-columns: 1fr;
    }
    
    .advanced-controls {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const slider = document.getElementById('exploration-slider');
    const valueDisplay = document.getElementById('exploration-value');
    const advancedToggle = document.getElementById('advanced-toggle');
    const advancedOptions = document.getElementById('advanced-options');
    
    // Update value display on slider change
    slider.addEventListener('input', function() {
        valueDisplay.textContent = parseFloat(this.value).toFixed(1);
    });
    
    // Advanced options toggle
    advancedToggle.addEventListener('click', function() {
        const isVisible = advancedOptions.style.display !== 'none';
        
        if (isVisible) {
            advancedOptions.style.display = 'none';
            this.classList.remove('active');
            this.querySelector('.toggle-text').textContent = 'Show Advanced Options';
        } else {
            advancedOptions.style.display = 'block';
            this.classList.add('active');
            this.querySelector('.toggle-text').textContent = 'Hide Advanced Options';
        }
    });
    
    // Restore advanced state from URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_advanced') === 'true' || 
        urlParams.get('max_play') || 
        urlParams.get('tag')) {
        advancedOptions.style.display = 'block';
        advancedToggle.classList.add('active');
        advancedToggle.querySelector('.toggle-text').textContent = 'Hide Advanced Options';
    }
    
    // Feedback buttons (if in enhanced mode)
    document.querySelectorAll('.btn-feedback').forEach(btn => {
        btn.addEventListener('click', function() {
            const trackId = this.dataset.trackId;
            const feedbackType = this.dataset.feedback;
            const explorationLevel = slider.value;
            
            // Toggle active state
            if (this.classList.contains('active')) {
                this.classList.remove('active');
                return;
            }
            
            // Remove active from other buttons for this track
            this.parentElement.querySelectorAll('.btn-feedback').forEach(b => {
                if (b !== this) b.classList.remove('active');
            });
            this.classList.add('active');
            
            // If it's a save button, also show the playlist modal
            if (feedbackType === 'save') {
                const artist = this.dataset.artist;
                const track = this.dataset.track;
                if (artist && track && window.NextTrack && window.NextTrack.showAddToPlaylist) {
                    // Call the playlist modal function
                    window.NextTrack.showAddToPlaylist(this);
                }
            }
            
            // Send feedback to API
            fetch('/api/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    track_id: trackId,
                    seed_track_id: {{ seed_track.id|default:"null" }},
                    feedback_type: feedbackType,
                    exploration_level: parseFloat(explorationLevel),
                    session_id: sessionStorage.getItem('session_id') || generateSessionId()
                })
            }).then(response => {
                if (response.ok) {
                    console.log('Feedback submitted successfully');
                }
            }).catch(error => {
                console.error('Error submitting feedback:', error);
            });
        });
    });
    
    // Generate session ID if not exists
    function generateSessionId() {
        const sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('session_id', sessionId);
        return sessionId;
    }
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}