{% extends "base.html" %}{% block content %}
<h2>
  {{ playlist.name }}
  <form method="post" style="display:inline">{% csrf_token %}
    {{ rename_form.name }}
    <button name="rename">Rename</button>
  </form>
</h2>

<ul id="track-list">
{% for item in tracks %}
  <li data-id="{{ item.track.id }}">
    {{ item.track.title }} — {{ item.track.artist.name }}
    <form method="post" style="display:inline">
      {% csrf_token %}
      <button name="remove_track" value="{{ item.track.id }}" style="font-size:0.8rem">×</button>
    </form>
  </li>
{% empty %}
  <li>This playlist is empty.</li>
{% endfor %}
</ul>

<button id="save-order" style="margin-top:1rem">Save order</button>

<script>
 // simple drag&drop reorder
 const list = document.getElementById("track-list");
 let el;
 list.ondragstart = e => { el = e.target; };
 list.ondragover  = e => e.preventDefault();
 list.ondrop = e => {
   if (e.target.tagName === "LI") list.insertBefore(el, e.target.nextSibling);
 };

 document.querySelectorAll("#track-list li").forEach(li=>{
   li.draggable = true;
 });

 document.getElementById("save-order").onclick = () => {
   const order = [...list.children].map(li=>li.dataset.id);
   fetch(location.href, {
     method:"POST",
     headers: {"X-CSRFToken":"{{ csrf_token }}"},  // csrf_token passed from template context
     body:new URLSearchParams({order:JSON.stringify(order)})
   }).then(()=>location.reload());
 };
</script>
{% endblock %}
