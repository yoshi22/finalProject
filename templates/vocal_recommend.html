{# templates/vocal_recommend.html #}
{% extends "base.html" %}
{% load static spn humanize %}

{% block title   %}Vocal Range Recommendation{% endblock %}
{% block css     %}{% endblock %}

{% block content %}
<h2>Search songs that fit your voice</h2>

<form method="post" class="vocal-range-form">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">Update</button>
</form>

{% if tracks %}
  <table class="table table-sm mt-4">
    <thead>
      <tr><th>#</th><th>Artist</th><th>Title</th><th>Key Range</th>
          <th>Preview</th><th>Video</th></tr>
    </thead>
    <tbody>
      {% for t in tracks %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ t.artist }}</td>
          <td>{{ t.title }}</td>
          <td>{{ t.pitch_low|spn }}–{{ t.pitch_high|spn }}</td>

          {# 30-sec preview (iTunes → Spotify fallback) #}
          {% firstof t.apple_preview t.preview_url "" as src %}
          <td>
            {% if not src and t.spotify_id %}
              <audio src="https://p.scdn.co/mp3-preview/{{ t.spotify_id }}" controls></audio>
            {% elif src %}
              <audio src="{{ src }}" controls></audio>
            {% else %}
              n/a
            {% endif %}
          </td>

          <td>
            {% if t.youtube_url %}
              <a href="{{ t.youtube_url }}" target="_blank">▶︎ YouTube</a>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}
