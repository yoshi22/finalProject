{# templates/vocal_recommend.html #}
{% extends "base.html" %}
{% load static %}
{% load spn %}

{% block content %}
<h2>Search songs to your vocal range</h2>

<form method="post" class="range-form">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Update</button>
</form>

{% if tracks %}
<table class="song-table">
  <thead>
    <tr>
      <th>#</th><th>Artist</th><th>Title</th>
      <th>Key&nbsp;Range<br>(MIDI)</th><th>Preview</th>
    </tr>
  </thead>
  <tbody>
  {% for t in tracks %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ t.artist }}</td>
      <td>{{ t.title }}</td>
      <td>{{ t.pitch_low|spn }} – {{ t.pitch_high|spn }}</td>
      <td>
        {# ---------- decide preview source --------------- #}
        {% firstof t.apple_preview t.preview_url "" as src %}
        {% if not src and t.spotify_id %}
          {# 最後の手段として旧 mp3-preview (30sec) #}
          {% with "https://p.scdn.co/mp3-preview/"|add:t.spotify_id as src %}
            <audio controls preload="none" style="width:160px">
              <source src="{{ src }}" type="audio/mpeg">
            </audio>
          {% endwith %}
        {% elif src %}
          <audio controls preload="none" style="width:160px">
            <source src="{{ src }}" type="audio/mpeg">
          </audio>
        {% else %}
          <span class="muted">n/a</span>
        {% endif %}

        {# ---------- YouTube full track --------------- #}
        {% if t.youtube_url %}
          <br><a href="{{ t.youtube_url }}" target="_blank" rel="noopener">
            ▶︎ YouTube
          </a>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}
{% endblock %}
